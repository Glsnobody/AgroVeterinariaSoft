@page "/UI/Regsitros/rComprasComponent"
@inject IToastService toastService

@using AgroVeterinariaSoft.Data;
@using AgroVeterinariaSoft.Models;
@using AgroVeterinariaSoft.Controllers;
    <h3 class="display-3 text-center">Registro de Compras</h3>
<div class="container">
    <EditForm Model="Compra" OnValidSubmit="Guardar">
        <div class="form-group">
            <label>Id</label>
            <div class="input-group">
                <InputNumber @bind-Value="Compra.CompraId" class="form-control" />
                <div class="input-group-append">
                    <button type="button" class="btn btn-primary" @onclick="Buscar">Buscar</button>
                </div>
            </div>

        </div>

        <div class="form-row">
            <div class="col form-group">
                <label>ClienteId</label>
                <div class="input-group">
                    <InputNumber @bind-Value="Compra.SuplidorId" class="form-control" />
                    <div class="input-group-append">
                        <button type="button" class="btn btn-primary" @onclick="BuscarSuplidor">Buscar</button>
                    </div>
                </div>
            </div>

            <div class="col form-group">
                <label>Nombre</label>
                <InputText @bind-Value="Suplidor.Nombre" class="form-control" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col">
                <label>Fecha</label>
                <InputDate @bind-Value="Compra.Fecha" class="form-control" />
            </div>

        </div>

        <div class="form-row">
            <div class="form-group col">
                <label>ProductoId</label>
                <div class="input-group">
                    <InputNumber @bind-Value="Producto.ProductoId" class="form-control" />
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-primary" @onclick="BuscarProducto">Buscar</button>
                    </div>
                </div>

            </div>

            <div class="form-group col">
                <label>Producto</label>
                <InputText @bind-Value="Producto.Descripcion" class="form-control" />
            </div>

            <div class="form-group col">
                <label>Cantidad</label>
                <div class="input-group">
                    <InputNumber @bind-Value="CantidadProducto" class="form-control" />
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-primary" @onclick="AgregarProducto">Agregar</button>
                    </div>
                </div>

            </div>
        </div>


        <div>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="row">Id</th>
                        <th scope="row">Producto</th>
                        <th scope="row">Precio</th>
                        <th scope="row">Cantidad</th>
                        <th scope="row">Importe</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var obj in Compra.ListaProductos)
                    {
                    <tr>
                        <td>@obj.ProductoId</td>
                        <td>@obj.Descripcion</td>
                        <td>@obj.Precio</td>
                        <td>@obj.Cantidad</td>
                        <td>@obj.Importe</td>
                        <td><button type="button" class="btn btn-sm btn-danger " @onclick="(()=> Compra.ListaProductos.Remove(obj))">Eliminar</button></td>
                    </tr>
                    }

                </tbody>

            </table>
        </div>
        <div class="form-group">
            <label for="TotalNumber"> </label>
            <InputNumber id="TotalNumber" @bind-Value="Compra.Total" class="form-control"/>

        </div>

        <div class="form-group">
            <button type="button" class="btn btn-primary" @onclick="Nuevo">Limpiar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-danger">Eliminar</button>
        </div>
    </EditForm>
</div>



@code {

    Compras Compra = new Compras();

    Suplidores Suplidor = new Suplidores();
    Productos Producto = new Productos();

    public int CantidadProducto { get; set; }

    public void Guardar()
    {
        try
        {
            if(ComprasController.Guardar(Compra))
            {
                Compra = new Compras();
                toastService.ShowSuccess("Guardado correctamente");
            }
            else
            {
                toastService.ShowInfo("No se pudo guardar");
            }
        }
        catch (Exception)
        {

            throw;
        }
    }

    public void BuscarSuplidor()
    {
        try
        {
            Suplidores temp = SuplidoresController.Buscar(Compra.SuplidorId);

            if(temp != null)
            {
                Suplidor = temp;
            }
            else
            {
                toastService.ShowInfo("No se encontro el suplidor");
            }
        }
        catch (Exception)
        {

            throw;
        }
    }

    private void AgregarProducto()
    {
        Compra.ListaProductos.Add(new DetalleProductos(
            iD: 0,
            compraId: Compra.CompraId,
            productoId: Producto.ProductoId,
            precio: Producto.Precio,
            cantidad:  CantidadProducto,
            descripcion: Producto.Descripcion,
            importe:Producto.Precio*CantidadProducto

            ));

        CalcularTotal();

        Producto = new Productos();
    }

    public void BuscarProducto()
    {
        try
        {
            Productos temp = ProductosController.Buscar(Producto.ProductoId);

            if(temp != null)
            {
                Producto = temp;
            }
            else
            {
                toastService.ShowInfo("No se encontro el producto");
            }
        }
        catch (Exception)
        {

            throw;
        }
    }

    public void Nuevo()
    {
        Compra = new Compras();
        Suplidor= new Suplidores();
        Producto = new Productos();
        
        CalcularTotal();

        CantidadProducto = 0;
        
    }

    private void CalcularTotal()
    {
        Compra.Total = Compra.ListaProductos.Sum(p => p.Importe);
    }

    public void Buscar()
    {
        try
        {
            Compras temp = ComprasController.Buscar(Compra.CompraId);

            if(temp != null)
            {
                Compra = temp;
                BuscarSuplidor();
            }
            else
            {
                toastService.ShowInfo("No se pudo encontrar");
            }
        }
        catch (Exception)
        {

            throw;
        }
    }

    public void Eliminar()
    {

    }
}
